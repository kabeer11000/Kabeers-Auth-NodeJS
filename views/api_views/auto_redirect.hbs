<script>
    (function () {
        const accounts = async (res) => {
            if (null === localStorage.getItem("accounts")) {
                const a = [{
                    username: res.user_data.username,
                    email: res.user_data.email,
                    password: btoa(res.user_data.password),
                    account_image: res.user_data.account_image
                }];
                localStorage.setItem("accounts", JSON.stringify(a))
            } else {
                var data = JSON.parse(localStorage.getItem("accounts")), currentData = {
                    username: res.user_data.username,
                    email: res.user_data.email,
                    password: btoa(res.user_data.password),
                    account_image: res.user_data.account_image
                };
                JSON.stringify(data).includes(JSON.stringify(currentData)) || (data.push({
                    username: res.user_data.username,
                    email: res.user_data.email,
                    password: btoa(res.user_data.password),
                    account_image: res.user_data.account_image
                }), localStorage.setItem("accounts", JSON.stringify(data)))
            }
        };
        const ajax = async (a = {}) => {
            return (await fetch(a.url, {...a})).json()
        };
        const getFormData = n => {
            let e = [];
            for (let o in n) n.hasOwnProperty(o) && e.push(encodeURIComponent(o) + "=" + encodeURIComponent(n[o]));
            return e.join("&")
        };
        const getToken = async () => {
            let t = void 0;
            return await ajax({
                url: "/auth/token",
                method: "POST",
                timeout: 0,
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: getFormData({
                    client_secret: "{{client_secret}}",
                    client_public: "{{client_public}}",
                    auth_code: "{{code}}"
                })
            }).then(function (e) {
                t = e
            }), t
        };
        const settings = {
            url: "/auth/allow",
            method: "POST",
            timeout: 0,
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: getFormData({username: "{{username_}}", password: "{{password_}}", auth_code: "{{code}}"})
        };
        ajax(settings).then((res) => {
            if (res) {
                accounts(res);
                "code" === '{{response_type}}' && (window.location.href = res.callback);
                if ("token" === '{{response_type}}') {
                    const e = new URLSearchParams(res.callback);
                    getToken().then(t => {
                        t && (window.location.href = `${res.callback.split(/[?#]/)[0]}?token=${encodeURI(JSON.stringify(t))}&nonce=${e.get("nonce")}&state=${e.get("state")}`)
                    })
                }
            }
        });
    })();
</script>
